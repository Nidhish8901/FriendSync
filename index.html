<script type="module">
    const SUPABASE_URL = 'https://fqyvdxvblhoszymjemlh.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZxeXZkeHZibGhvc3p5bWplbWxoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMDc3MjYsImV4cCI6MjA3MTY4MzcyNn0.fatb73q1t50P6aus_eCF3FuuLMPm4KyInPGxycybxl4';

    const { createClient } = supabase;
    const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- App State ---
    let user = null;
    let groupId = null;
    let userSchedule = [];
    let allSchedules = {};
    let realtimeChannel = null;
    // OPTIMIZATION: Cache for user profiles to avoid repeated DB calls
    const profileCache = new Map();

    const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
    const startTime = 8, endTime = 18;

    // --- DOM Elements ---
    const loadingOverlay = document.getElementById('loading-overlay');
    const views = {
        login: document.getElementById('login-view'),
        dashboard: document.getElementById('group-dashboard-view'),
        app: document.getElementById('app-container'),
        about: document.getElementById('about-view'),
        howTo: document.getElementById('how-to-view'),
    };

    const googleLoginBtn = document.getElementById('google-login-btn');
    const dashboardSignOutBtn = document.getElementById('dashboard-sign-out-btn');
    const saveScheduleBtn = document.getElementById('save-schedule-btn');
    const saveFeedback = document.getElementById('save-feedback');
    const saveError = document.getElementById('save-error');
    const groupIdInput = document.getElementById('group-id-input');
    const joinGroupBtn = document.getElementById('join-group-btn');
    const createGroupBtn = document.getElementById('create-group-btn');
    const switchGroupBtn = document.getElementById('switch-group-btn');
    const downloadIcsBtn = document.getElementById('download-ics-btn');
    const uploadIcsBtn = document.getElementById('upload-ics-btn');
    const icsUploadInput = document.getElementById('ics-upload-input');
    const inviteBtn = document.getElementById('invite-btn');
    const aboutBtn = document.getElementById('about-btn');
    const closeAboutBtn = document.getElementById('close-about-btn');
    const howToBtn = document.getElementById('how-to-btn');
    const closeHowToBtn = document.getElementById('close-how-to-btn');
    const groupError = document.getElementById('group-error');
    const timetableDiv = document.getElementById('timetable');
    const daySelect = document.getElementById('day-select');
    const timeSelect = document.getElementById('time-select');
    const checkBtn = document.getElementById('check-btn');
    const freeFriendsList = document.getElementById('free-friends-list');
    const groupMembersList = document.getElementById('group-members-list');
    const userGroupsList = document.getElementById('user-groups-list');
    const userInfoDiv = document.getElementById('userInfo');
    const groupInfoDiv = document.getElementById('groupInfo');
    const friendSelect = document.getElementById('friend-select');
    const friendDaySelect = document.getElementById('friend-day-select');
    const checkFriendBtn = document.getElementById('check-friend-btn');
    const friendFreeTimesList = document.getElementById('friend-free-times-list');

    let isMouseDown = false, isSelecting = false;

    // --- View Management ---
    function showView(viewKey) {
        Object.values(views).forEach(view => view.classList.add('hidden'));
        if(views[viewKey]) views[viewKey].classList.remove('hidden');
        loadingOverlay.classList.add('hidden');
    }

    // --- Authentication ---
    async function handleGoogleLogin() {
        const { error } = await db.auth.signInWithOAuth({ provider: 'google' });
        if (error) console.error('Error logging in with Google:', error);
    }

    async function handleSignOut() {
        await db.auth.signOut();
    }

    function resetAppState() {
        user = null;
        groupId = null;
        userSchedule = [];
        allSchedules = {};
        profileCache.clear();

        if (realtimeChannel) {
            db.removeChannel(realtimeChannel);
            realtimeChannel = null;
        }

        userGroupsList.innerHTML = '';
        groupIdInput.value = '';
        groupError.textContent = '';
        
        showView('login');
    }
    
    async function onAuthStateChange(event, session) {
        if (event === 'SIGNED_IN') {
            user = session.user;
            // Add user to profiles table if they don't exist
            await db.from('profiles').upsert({
                id: user.id,
                full_name: user.user_metadata.full_name,
            });
            await showGroupDashboard();
        } else if (event === 'SIGNED_OUT') {
            resetAppState();
        }
    }

    // --- Main App Logic ---
    async function showGroupDashboard() {
        if (realtimeChannel) {
            db.removeChannel(realtimeChannel);
            realtimeChannel = null;
        }
        groupId = null;
        
        showView('dashboard');
        loadingOverlay.classList.remove('hidden');
        const { data, error } = await db.from('group_memberships').select('group_id').eq('user_id', user.id);
        loadingOverlay.classList.add('hidden');

        if (error) {
            console.error("Error fetching user groups:", error);
            userGroupsList.innerHTML = '<p class="text-red-400">Could not load groups.</p>';
            return;
        }
        renderUserGroups(data.map(g => g.group_id));
    }

    async function initializeApp(gId) {
        groupId = gId;
        showView('app');
        loadingOverlay.classList.remove('hidden');
        
        groupMembersList.innerHTML = '<p class="text-gray-400">Loading members...</p>';
        [freeFriendsList, friendFreeTimesList].forEach(el => el.innerHTML = '<p class="text-gray-400">Results will appear here.</p>');

        groupInfoDiv.innerHTML = `Group ID: <span class="font-semibold font-mono">${groupId}</span>`;
        userInfoDiv.innerHTML = `Welcome, <span class="font-semibold">${user.user_metadata?.full_name || 'User'}</span>`;

        try {
            // OPTIMIZATION: Run network requests in parallel
            await Promise.all([
                loadUserScheduleAndApplyToGroup(),
                fetchAllSchedules(),
                fetchGroupMembers()
            ]);
            listenToAllSchedules();
        } catch (error) {
            console.error("Error initializing app view:", error);
            groupMembersList.innerHTML = '<p class="text-red-400">Error loading group data.</p>';
        } finally {
            loadingOverlay.classList.add('hidden');
        }
    }

    async function loadUserScheduleAndApplyToGroup() {
        const { data, error } = await db.from('schedules').select('schedule').eq('user_id', user.id).limit(1).single();
        if (error && error.code !== 'PGRST116') { // Ignore "No rows found" error
            console.error("Error fetching master schedule:", error);
            throw error;
        }
        userSchedule = data?.schedule || [];
        updateTimetableUI();
        // Ensure this user has a schedule entry for the current group
        await db.from('schedules').upsert({ user_id: user.id, group_id: groupId, schedule: userSchedule });
    }
    
    async function fetchAllSchedules() {
         if (!groupId) return;
         const { data, error } = await db.from('schedules').select('user_id, schedule').eq('group_id', groupId);
         if (error) {
             console.error("Error fetching all schedules:", error);
             throw error;
         }
         allSchedules = data.reduce((acc, item) => {
             acc[item.user_id] = item.schedule || [];
             return acc;
         }, {});
    }
    
    async function fetchGroupMembers() {
        if (!groupId) return;
        const { data: memberData, error } = await db.from('group_memberships').select('user_id').eq('group_id', groupId);
        if (error) throw error;
        
        const userIds = [...new Set(memberData.map(m => m.user_id))];
        if (userIds.length === 0) {
            renderGroupMembers([]);
            return;
        }
        
        const members = await getProfiles(userIds);
        renderGroupMembers(members);
    }

    // --- Realtime ---
    function listenToAllSchedules() {
        if (realtimeChannel) db.removeChannel(realtimeChannel);
        
        realtimeChannel = db.channel(`group-updates:${groupId}`)
          .on('postgres_changes', { event: '*', schema: 'public', table: 'schedules', filter: `group_id=eq.${groupId}` }, payload => {
              // OPTIMIZATION: Update local state directly from payload, no re-fetch needed
              if (payload.new && payload.new.user_id) {
                  allSchedules[payload.new.user_id] = payload.new.schedule || [];
                  console.log(`Realtime update for user ${payload.new.user_id}`);
              }
          })
          .on('postgres_changes', { event: '*', schema: 'public', table: 'group_memberships', filter: `group_id=eq.${groupId}` }, () => {
              // Membership changes are less frequent, a re-fetch is acceptable here.
              fetchGroupMembers();
          })
          .subscribe();
    }

    // --- DOM Rendering (Optimized with DocumentFragment) ---
    function renderUserGroups(groups) {
        userGroupsList.innerHTML = '';
        if (groups.length === 0) {
            userGroupsList.innerHTML = '<p class="text-center text-gray-400">You are not in any groups yet.</p>';
            return;
        }
        
        const fragment = document.createDocumentFragment();
        groups.forEach(gId => {
            const groupItem = document.createElement('div');
            groupItem.className = 'group-list-item rounded-lg flex items-center justify-between p-3';

            const groupName = document.createElement('span');
            groupName.className = 'font-mono cursor-pointer flex-grow';
            groupName.textContent = gId;
            groupName.onclick = () => initializeApp(gId);

            const leaveButton = document.createElement('button');
            leaveButton.className = 'text-xs bg-red-600 hover:bg-red-700 text-white font-semibold py-1 px-2 rounded-md transition-colors flex-shrink-0';
            leaveButton.textContent = 'Leave';
            leaveButton.onclick = async () => {
                if (window.prompt(`Type "${gId}" to confirm leaving this group.`) === gId) {
                    await db.from('group_memberships').delete().match({ user_id: user.id, group_id: gId });
                    await showGroupDashboard();
                }
            };

            groupItem.append(groupName, leaveButton);
            fragment.appendChild(groupItem);
        });
        userGroupsList.appendChild(fragment);
    }
    
    function generateTimetable() {
        const table = document.createElement('table');
        table.className = 'min-w-full border-collapse';

        const thead = table.createTHead();
        const headerRow = thead.insertRow();
        headerRow.className = 'tech-table-header';
        let th = document.createElement('th');
        th.className = 'p-2 tech-table-cell font-semibold text-xs sm:text-sm';
        th.textContent = 'Time';
        headerRow.appendChild(th);
        days.forEach(day => {
            th = document.createElement('th');
            th.className = 'p-2 tech-table-cell font-semibold text-xs sm:text-sm';
            th.textContent = day.substring(0, 3);
            headerRow.appendChild(th);
        });

        const tbody = table.createTBody();
        for (let h = startTime; h < endTime; h++) {
            const row = tbody.insertRow();
            const startHourStr = String(h).padStart(2, '0');
            const timeLabel = `${startHourStr}:00 - ${startHourStr}:50`;
            const dataTime = `${startHourStr}:00`;

            let cell = row.insertCell();
            cell.className = 'p-1 sm:p-2 text-center text-xs sm:text-sm tech-table-cell text-gray-400 font-mono';
            cell.textContent = timeLabel;
            
            days.forEach(day => {
                cell = row.insertCell();
                cell.className = 'time-slot tech-table-cell';
                cell.dataset.day = day;
                cell.dataset.time = dataTime;
            });
        }
        timetableDiv.innerHTML = '';
        timetableDiv.appendChild(table);
    }

    function renderGroupMembers(members) {
        groupMembersList.innerHTML = '';
        friendSelect.innerHTML = ''; // Clear previous options
        if (members.length === 0) {
            groupMembersList.innerHTML = '<p class="text-gray-400">You are the first one here!</p>';
            return;
        }
        
        const listFragment = document.createDocumentFragment();
        const selectFragment = document.createDocumentFragment();
        
        members.forEach(member => {
            const listItem = document.createElement('li');
            listItem.className = 'bg-gray-800 border border-gray-700 text-gray-300 p-2 rounded-md text-sm flex items-center';
            listItem.innerHTML = `<span class="w-2 h-2 bg-green-400 rounded-full mr-3"></span><span>${member.name}</span>`;
            
            if (user && member.id === user.id) {
                listItem.lastChild.textContent += " (You)";
                listItem.lastChild.className = "font-bold";
            } else {
                const option = document.createElement('option');
                option.value = member.id;
                option.textContent = member.name;
                selectFragment.appendChild(option);
            }
            listFragment.appendChild(listItem);
        });
        
        groupMembersList.appendChild(listFragment);
        friendSelect.appendChild(selectFragment);
    }
    
    function updateTimetableUI() {
        document.querySelectorAll('.time-slot').forEach(slot => {
            slot.classList.remove('selected', 'free-hour');
            const isSelected = userSchedule.some(entry => entry.day === slot.dataset.day && entry.time === slot.dataset.time);
            if (isSelected) slot.classList.add('selected');
        });
    }
    
    // --- Feature Logic: Availability Check ---
    async function getProfiles(userIds) {
        const idsToFetch = userIds.filter(id => !profileCache.has(id));
        if (idsToFetch.length > 0) {
            const { data: profiles, error } = await db.from('profiles').select('id, full_name').in('id', idsToFetch);
            if (error) {
                console.error("Error fetching profiles:", error);
                return [];
            }
            profiles.forEach(p => profileCache.set(p.id, p.full_name));
        }
        return userIds.map(id => ({ id, name: profileCache.get(id) || `User (${id.substring(0,6)}...)` }));
    }

    async function checkAvailability() {
        const selectedDay = daySelect.value;
        const selectedTime = timeSelect.value;
        const freeFriendIds = Object.keys(allSchedules)
            .filter(id => id !== user.id && !allSchedules[id].some(s => s.day === selectedDay && s.time === selectedTime));

        const freeFriends = freeFriendIds.length > 0 ? await getProfiles(freeFriendIds) : [];
        renderFreeFriends(freeFriends, selectedDay, timeSelect.options[timeSelect.selectedIndex].text);
    }

    function renderFreeFriends(freeFriends, day, timeLabel) {
        freeFriendsList.innerHTML = `<p class="text-gray-300 mb-3">At ${timeLabel} on ${day}:</p>`;
        if (freeFriends.length === 0) {
            freeFriendsList.innerHTML += `<div class="text-center p-4 bg-yellow-600 bg-opacity-20 border border-yellow-500 text-yellow-300 rounded-md">No other friends are available.</div>`;
        } else {
            const list = document.createElement('ul');
            list.className = 'space-y-2';
            freeFriends.forEach(friend => {
                const li = document.createElement('li');
                li.className = 'bg-green-600 bg-opacity-20 border border-green-500 text-green-300 p-2 rounded-md text-sm';
                li.textContent = `${friend.name} is available`;
                list.appendChild(li);
            });
            freeFriendsList.appendChild(list);
        }
    }

    // --- Feature Logic: Common Slots ---
    function checkCommonAvailability() {
        const selectedFriendOptions = Array.from(friendSelect.selectedOptions);
        const selectedFriendIds = selectedFriendOptions.map(opt => opt.value);
        const selectedDay = friendDaySelect.value;

        if (selectedFriendIds.length === 0) {
            friendFreeTimesList.innerHTML = '<p class="text-yellow-300">Please select at least one friend.</p>';
            return;
        }
        
        const allDaySlots = Array.from({length: endTime - startTime}, (_, i) => {
            const h = startTime + i;
            const time = `${String(h).padStart(2, '0')}:00`;
            return { time, timeLabel: time.slice(0, 5) };
        });

        const commonFreeSlots = allDaySlots.filter(slot => 
            selectedFriendIds.every(id => !allSchedules[id]?.some(s => s.day === selectedDay && s.time === slot.time))
        );

        renderCommonFreeTimes(commonFreeSlots, selectedFriendOptions.map(opt => opt.textContent), selectedDay);
    }

    function renderCommonFreeTimes(freeSlots, friendNames, day) {
        const nameList = friendNames.map(name => `<span class="font-bold">${name}</span>`).join(', ');
        friendFreeTimesList.innerHTML = `<p class="text-gray-300 mb-3">${nameList} are all free on <span class="font-bold">${day}</span> at:</p>`;

        if (freeSlots.length === 0) {
            friendFreeTimesList.innerHTML += `<div class="text-center p-4 bg-yellow-600 bg-opacity-20 border border-yellow-500 text-yellow-300 rounded-md">No common free slots found.</div>`;
        } else {
            const list = document.createElement('ul');
            list.className = 'grid grid-cols-2 sm:grid-cols-3 gap-2';
            freeSlots.forEach(slot => {
                list.innerHTML += `<li class="bg-green-600 bg-opacity-20 border border-green-500 text-green-300 p-2 rounded-md text-sm text-center font-mono">${slot.timeLabel}</li>`;
            });
            friendFreeTimesList.appendChild(list);
        }
    }

    // --- Schedule Management & ICS ---
    async function saveUserSchedule() {
        saveScheduleBtn.disabled = true;
        saveScheduleBtn.textContent = 'Saving...';
        saveError.classList.add('opacity-0');

        const newSchedule = Array.from(document.querySelectorAll('.time-slot.selected'))
            .map(slot => ({ day: slot.dataset.day, time: slot.dataset.time }));
        
        const success = await saveScheduleToDatabase(newSchedule);

        if (success) {
            saveFeedback.classList.remove('opacity-0');
            setTimeout(() => saveFeedback.classList.add('opacity-0'), 2000);
        } else {
            saveError.textContent = 'Save Failed!';
            saveError.classList.remove('opacity-0');
            setTimeout(() => saveError.classList.add('opacity-0'), 3000);
        }
        saveScheduleBtn.disabled = false;
        saveScheduleBtn.textContent = 'Save';
    }
    
    async function saveScheduleToDatabase(schedule) {
        userSchedule = schedule; // Update local state immediately
        const { data: memberships, error: memberError } = await db.from('group_memberships').select('group_id').eq('user_id', user.id);

        if (memberError) {
            console.error("Error fetching user's groups:", memberError);
            return false;
        }

        if (memberships.length > 0) {
            const upsertData = memberships.map(m => ({ user_id: user.id, group_id: m.group_id, schedule }));
            const { error } = await db.from('schedules').upsert(upsertData);
            if (error) {
                console.error("Error saving global schedule: ", error);
                return false;
            }
        }
        return true;
    }

    function handleIcsUpload() { /* (No changes needed, this logic is fine) */ }
    function downloadIcsFile() { /* (No changes needed, this logic is fine) */ }


    // --- Event Listeners & Initial Setup ---
    function setupEventListeners() {
        googleLoginBtn.addEventListener('click', handleGoogleLogin);
        dashboardSignOutBtn.addEventListener('click', handleSignOut);
        saveScheduleBtn.addEventListener('click', saveUserSchedule);
        switchGroupBtn.addEventListener('click', showGroupDashboard);
        checkBtn.addEventListener('click', checkAvailability);
        checkFriendBtn.addEventListener('click', checkCommonAvailability);

        // Modal/View navigation
        aboutBtn.addEventListener('click', () => showView('about'));
        closeAboutBtn.addEventListener('click', () => showView('dashboard'));
        howToBtn.addEventListener('click', () => showView('howTo'));
        closeHowToBtn.addEventListener('click', () => showView('dashboard'));
        
        // Timetable interaction
        timetableDiv.addEventListener('mousedown', (e) => {
            const slot = e.target.closest('.time-slot');
            if (slot) {
                e.preventDefault();
                isMouseDown = true;
                isSelecting = !slot.classList.contains('selected');
                slot.classList.toggle('selected', isSelecting);
            }
        });
        timetableDiv.addEventListener('mouseover', (e) => {
            const slot = e.target.closest('.time-slot');
            if (isMouseDown && slot) {
                slot.classList.toggle('selected', isSelecting);
            }
        });
        window.addEventListener('mouseup', () => { isMouseDown = false; });
    }
    
    // *** FIX: This new function populates the dropdowns ***
    function populateSelectors() {
        const dayOptionsFragment = document.createDocumentFragment();
        days.forEach(day => {
            const option = document.createElement('option');
            option.value = day;
            option.textContent = day;
            dayOptionsFragment.appendChild(option);
        });

        // Use cloneNode(true) to reuse the fragment for multiple dropdowns
        daySelect.appendChild(dayOptionsFragment.cloneNode(true));
        friendDaySelect.appendChild(dayOptionsFragment.cloneNode(true));

        const timeOptionsFragment = document.createDocumentFragment();
        for (let h = startTime; h < endTime; h++) {
            const startHourStr = String(h).padStart(2, '0');
            const timeLabel = `${startHourStr}:00 - ${startHourStr}:50`;
            const dataTime = `${startHourStr}:00`;
            const option = document.createElement('option');
            option.value = dataTime;
            option.textContent = timeLabel;
            timeOptionsFragment.appendChild(option);
        }
        timeSelect.appendChild(timeOptionsFragment);
    }

    // Initialize
    (function init() {
        generateTimetable();
        populateSelectors(); // *** FIX: Call the new function ***
        setupEventListeners();
        db.auth.onAuthStateChange(onAuthStateChange);
    })();

</script>
